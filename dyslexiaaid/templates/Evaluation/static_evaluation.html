{% extends "base.html" %}
{% block content %}
<div class="relative z-10 max-w-4xl mx-auto p-6">
  <h2 class="text-2xl font-bold text-violet-900 mb-6">
    Evaluation Test ‚Äì {{ dyslexia_type }}
  </h2>
  <p class="text-gray-600 mb-6">
    Please complete the following {{ questions|length }} interactive questions to help us evaluate {{ dyslexia_type }}.
  </p>

  <form method="POST" class="space-y-6" id="evaluationForm">
    {% csrf_token %}

<!-- Update the template to handle all interaction types properly -->
{% for question in questions %}
<div class="p-4 bg-violet-50 rounded-xl shadow-sm question-container" 
     data-question-type="{{ question.interaction }}"
     data-question-id="{{ question.id }}"
     data-metrics="{{ question.metrics|join:',' }}">
  
  <p class="font-medium text-gray-800 mb-2">{{ forloop.counter }}. {{ question.text }}</p>
  
  {% if question.hint %}
  <p class="text-sm text-violet-600 mb-3 italic">{{ question.hint }}</p>
  {% endif %}

  <!-- Speech-based Interactions (for Gemma audio analysis) -->
  {% if "recognition" in question.interaction or "naming" in question.interaction or "phoneme" in question.interaction or "rhyme" in question.interaction or "sound" in question.interaction %}
  <div class="speech-interaction">
    <div class="flex items-center space-x-3">
      <button type="button" class="record-btn px-3 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition text-sm">
        üé§ Start Recording
      </button>
      <span class="recording-status text-gray-600 text-sm">Click to record your answer</span>
    </div>
    <div class="mt-2 hidden" id="result-{{ question.id }}">
      <p class="text-sm">You said: <span class="font-medium text-violet-700" id="transcript-{{ question.id }}"></span></p>
      <input type="hidden" name="q{{ question.id }}" id="input-{{ question.id }}">
    </div>
  </div>

  <!-- Visual/Tracking Interactions (for Gemma visual pattern analysis) -->
  {% elif "visual" in question.interaction or "tracking" in question.interaction or "orientation" in question.interaction %}
  <div class="visual-interaction text-center">
    {% if question.interaction == "visual_tracking" %}
    <div class="border border-violet-200 p-4 rounded-lg mb-3 bg-white" id="tracking-area-{{ question.id }}">
      <p class="text-2xl font-mono text-gray-800 tracking-wider">elephant</p>
    </div>
    <p class="text-sm text-gray-600">Trace the word with your mouse or finger</p>
    <input type="hidden" name="q{{ question.id }}" value="tracking_data" id="visual-input-{{ question.id }}">
    
    {% else %}
    <!-- Visual choice questions -->
    <div class="space-y-2">
      {% if question.interaction == "letter_orientation" %}
      <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
        <input type="radio" name="q{{ question.id }}" value="left" class="mr-2"> Left
      </label>
      <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
        <input type="radio" name="q{{ question.id }}" value="right" class="mr-2"> Right
      </label>
      {% elif question.interaction == "word_reversal" %}
      <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
        <input type="radio" name="q{{ question.id }}" value="same" class="mr-2"> Same
      </label>
      <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
        <input type="radio" name="q{{ question.id }}" value="different" class="mr-2"> Different
      </label>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- Timed/Performance Interactions (for Gemma speed/accuracy analysis) -->
  {% elif question.timed or "rapid" in question.interaction %}
  <div class="timed-interaction">
    <div class="flex justify-between items-center mb-3 p-2 bg-white rounded-lg">
      <span class="font-medium text-sm">Time limit: {{ question.time_limit }} seconds</span>
      <span class="timer text-violet-600 font-bold" data-time-limit="{{ question.time_limit }}">{{ question.time_limit }}</span>
    </div>
    
    <div class="flex space-x-4 mb-3 justify-center">
      {% if question.interaction == "rapid_picture_naming" %}
      <div class="text-3xl">üê± üöó üåû üèÄ</div>
      {% elif question.interaction == "color_naming" %}
      <div class="space-x-2">
        <span class="px-3 py-1 bg-red-500 text-white rounded text-sm">RED</span>
        <span class="px-3 py-1 bg-blue-500 text-white rounded text-sm">BLUE</span>
        <span class="px-3 py-1 bg-green-500 text-white rounded text-sm">GREEN</span>
        <span class="px-3 py-1 bg-yellow-500 text-white rounded text-sm">YELLOW</span>
      </div>
      {% endif %}
    </div>
    
    <button type="button" class="start-timing px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition w-full">
      Start Exercise
    </button>
    <input type="hidden" name="q{{ question.id }}" id="timed-input-{{ question.id }}">
  </div>

  <!-- Cognitive/Decision Interactions (for Gemma reasoning analysis) -->
  {% elif "recognition" in question.interaction or "authenticity" in question.interaction or "understanding" in question.interaction %}
  <div class="space-y-2">
    {% if question.interaction == "spelling_recognition" %}
    <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
      <input type="radio" name="q{{ question.id }}" value="friend" class="mr-2"> friend
    </label>
    <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
      <input type="radio" name="q{{ question.id }}" value="frend" class="mr-2"> frend
    </label>
    {% elif question.interaction == "word_authenticity" %}
    <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
      <input type="radio" name="q{{ question.id }}" value="knight" class="mr-2"> knight
    </label>
    <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
      <input type="radio" name="q{{ question.id }}" value="nite" class="mr-2"> nite
    </label>
    {% elif question.interaction == "context_understanding" %}
    <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
      <input type="radio" name="q{{ question.id }}" value="yes" class="mr-2"> Yes, it makes sense
    </label>
    <label class="flex items-center p-2 rounded-lg hover:bg-violet-100 cursor-pointer transition">
      <input type="radio" name="q{{ question.id }}" value="no" class="mr-2"> No, it doesn't make sense
    </label>
    {% endif %}
  </div>

  <!-- Fallback for unimplemented interactions -->
  {% else %}
  <div class="space-y-2">
    <p class="text-sm text-orange-600">Specialized interaction for analysis</p>
    <textarea name="q{{ question.id }}" class="w-full p-2 border rounded" 
              placeholder="Your response will be analyzed by our AI..."></textarea>
  </div>
  {% endif %}
</div>
{% endfor %}
    <!-- Submit Button -->
    <div class="text-center mt-8">
      <button type="submit"
        class="px-6 py-3 bg-violet-600 text-white font-semibold rounded-xl shadow-md hover:bg-violet-700 transition">
        Submit Evaluation
      </button>
    </div>
  </form>
</div>

<!-- Speech Recognition Script -->
<script>
// Speech recognition functionality
class SpeechRecognitionHelper {
    constructor() {
        this.recognition = null;
        this.isRecording = false;
        this.currentQuestionId = null;
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SpeechRecognition();
            this.recognition.continuous = false;
            this.recognition.interimResults = false;
            this.recognition.lang = 'en-US';
            
            this.recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                this.handleRecognitionResult(transcript);
            };
            
            this.recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                this.updateStatus('Error: ' + event.error, 'error');
            };
        }
    }
    
    startRecording(questionId) {
        if (!this.recognition) {
            alert('Speech recognition not supported in your browser. Please use Chrome or Edge.');
            return;
        }
        
        this.currentQuestionId = questionId;
        this.isRecording = true;
        this.updateStatus('Recording... Speak now!', 'recording');
        
        try {
            this.recognition.start();
        } catch (error) {
            console.error('Recognition start error:', error);
        }
    }
    
    handleRecognitionResult(transcript) {
        if (this.currentQuestionId) {
            document.getElementById(`transcript-${this.currentQuestionId}`).textContent = transcript;
            document.getElementById(`input-${this.currentQuestionId}`).value = transcript;
            document.getElementById(`result-${this.currentQuestionId}`).classList.remove('hidden');
        }
        
        this.isRecording = false;
        this.updateStatus('Recording complete!', 'complete');
    }
    
    updateStatus(message, type) {
        if (this.currentQuestionId) {
            const statusElement = document.querySelector(`[data-question-id="${this.currentQuestionId}"] .recording-status`);
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `recording-status text-sm ${
                    type === 'recording' ? 'text-red-600 font-medium' : 
                    type === 'complete' ? 'text-green-600 font-medium' : 
                    type === 'error' ? 'text-red-600 font-medium' : 'text-gray-600'
                }`;
            }
        }
    }
}

// Initialize speech recognition
const speechHelper = new SpeechRecognitionHelper();

// Add event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Speech recording buttons
    document.querySelectorAll('.record-btn').forEach(button => {
        button.addEventListener('click', function() {
            const questionId = this.closest('.question-container').dataset.questionId;
            speechHelper.startRecording(questionId);
        });
    });
    
    // Timed exercises
    document.querySelectorAll('.start-timing').forEach(button => {
        button.addEventListener('click', function() {
            const container = this.closest('.timed-interaction');
            const timerElement = container.querySelector('.timer');
            const timeLimit = parseInt(timerElement.dataset.timeLimit);
            const questionId = this.closest('.question-container').dataset.questionId;
            
            this.disabled = true;
            this.textContent = 'Naming...';
            this.classList.add('bg-orange-500');
            
            let timeLeft = timeLimit;
            const countdown = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;
                timerElement.classList.toggle('text-red-600', timeLeft <= 3);
                
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    this.textContent = 'Completed!';
                    this.classList.remove('bg-orange-500');
                    this.classList.add('bg-green-500');
                    document.getElementById(`timed-input-${questionId}`).value = 'completed';
                }
            }, 1000);
        });
    });
});
</script>

<style>
.recording-status.recording {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Maintain your original violet color scheme */
.bg-violet-50 { background-color: #f5f3ff; }
.bg-violet-100 { background-color: #ede9fe; }
.bg-violet-600 { background-color: #7c3aed; }
.bg-violet-700 { background-color: #6d28d9; }
.text-violet-600 { color: #7c3aed; }
.text-violet-700 { color: #6d28d9; }
</style>
{% endblock %}